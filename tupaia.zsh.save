source "$ZSH/custom/utils.sh"

alias ctup="cd $TUPAIA_ROOT/tupaia"
alias ctup2="cd $TUPAIA_ROOT/tupaia2"
alias mgu="yarn migrate"
alias mgd="yarn migrate-down"
alias mgdu="yarn migrate-down && yarn migrate"
alias tap="tup_workspace admin-panel"
alias taps="tup_workspace admin-panel-server"
alias tes="tup_workspace entity-server"
alias tms="tup_workspace meditrak-server"
alias trs="tup_workspace report-server"
alias twc="tup_workspace web-config-server"
alias twf="tup_workspace web-frontend"

# @param1: A string which represent a tupaia project path
# @returns The root path for the provided tupaia project, if valid;
#   if not, it defaults to the "tupaia" project
#
# Examples
# --------
# $TUPAIA_ROOT/tupaia => $TUPAIA_ROOT/tupaia
# $TUPAIA_ROOT/tupaia2 => $TUPAIA_ROOT/tupaia2
# $TUPAIA_ROOT/tupaia2/a/sub/path => $TUPAIA_ROOT/tupaia2
# /non/tupaia/path => $TUPAIA_ROOT/tupaia
function get_tupaia_project_root() {
  local project_root=$(echo $1 | sed -rn "s|.*$TUPAIA_ROOT/([^/]*)/.*|\1|p")
  if [[ root_folder == "" ]; then
    project_root="tupaia"
  fi

  echo "$TUPAIA_ROOT/$projec_root"
}

function tup_workspace() {
  workspace=$1

  project_root=$(get_tupaia_project_root $(pwd))


  if [[ $2 == "" ]]; then
    return
  elif [[ $2 == "-s" ]]; then
    run "yarn start"
  else
    shift
    run "yarn $*"
  fi
}

function tup() {
  case $1 in
  rdb)
    shift
    tup_rdb "$@"
    ;;
  ssh)
    shift
    tup_ssh "$@"
    ;;
  start)
    shift
    tup_start "$@"
    ;;
  *)
    echo "Usage: tup <command> [<args>]

Commands:
  ssh     SSH to an EC2 instance
  start   Start a full-stack app locally"
    return 1
    ;;
  esac
}

function tup_rdb() {
  yarn dump-database $MEDITRAK_SSH_KEY "$@"
  yarn refresh-database dump.sql
}

function tup_ssh() {
  local server=$1
  if [ "$server" = "" ]; then
    echo "Usage: tup ssh <server>"
    return 1
  fi

  sed -i.bak -e d ~/.ssh/known_hosts
  local host=ubuntu@$server-ssh.tupaia.org
  ssh -o StrictHostKeyChecking=no -i $MEDITRAK_SSH_KEY $host
}

function tup_start() {
  local app=$1

  case $1 in
  tupaia)
    cmd.exe /c \
      "wt -w 0 wsl.exe . $NVM_DIR/nvm.sh\; \
       cd $TUPAIA_ROOT/tupaia\; \
       yarn workspace @tupaia/web-config-server start"
    cmd.exe /c \
      "wt -w 0 split-pane -H wsl.exe . $NVM_DIR/nvm.sh\; \
       cd $TUPAIA_ROOT/tupaia\; \
       yarn workspace @tupaia/web-frontend start"
    ;;
  *)
    echo "Usage: tup start tupaia"
    return 1
    ;;
  esac
}
